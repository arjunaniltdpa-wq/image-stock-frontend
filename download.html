  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- =========================
        DYNAMIC SEO (Controlled by JS)
    ========================== -->
    <title id="seo-title">Pixeora Photo</title>

    <meta id="seo-desc" name="description" content="Download high-quality HD wallpapers & royalty-free stock images for free.">
    <meta id="seo-keywords" name="keywords"
          content="free hd wallpaper download, 4k image download, stock photo download, royalty free images, commercial use photos, aesthetic backgrounds, nature wallpapers, abstract wallpapers, USA UK Canada Australia India wallpaper download">

    <!-- Canonical (dynamic by JS) -->
    <link id="canonical-link" rel="canonical" href="">

    <!-- =========================
        PERFORMANCE BOOST
    ========================== -->
    <link rel="preload" href="/css/download.css" as="style">
    <link rel="stylesheet" href="/css/download.css">

    <link rel="preconnect" href="https://cdn.pixeora.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.pixeora.com">

    <link rel="preconnect" href="https://api.pixeora.com" crossorigin>
    <link rel="dns-prefetch" href="https://api.pixeora.com">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Marck+Script&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- =========================
        SOCIAL SHARING (Dynamic OG Tags)
    ========================== -->
    <meta id="og-title" property="og:title" content="Pixeora Image">
    <meta id="og-desc" property="og:description" content="Download full HD wallpapers & royalty-free stock images.">
    <meta id="og-image" property="og:image" content="">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Pixeora">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta id="twitter-title" name="twitter:title" content="Pixeora Image Download">
    <meta id="twitter-desc" name="twitter:description" content="Download high-quality wallpapers, 4K backgrounds, and stock images.">
    <meta id="twitter-image" name="twitter:image" content="">

    <!-- =========================
        STRUCTURED DATA (Dynamic ImageObject)
        Boosts Google Image ranking!
    ========================== -->
    <script type="application/ld+json" id="ld-json">
    {
      "@context": "https://schema.org",
      "@type": "ImageObject",
      "name": "",
      "description": "",
      "contentUrl": "",
      "thumbnailUrl": "",
      "creator": {
        "@type": "Organization",
        "name": "Pixeora"
      },
      "license": "https://pixeora.com/license"
    }
    </script>

  </head>

<body>

<header class="header">
  <div class="header-overlay">

    <a href="/index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" id="searchForm">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="/images/search-icon.png" alt="Search" loading="lazy">
          </button>
        </form>
      </div>
    </div>

    <a href="/legal.html" class="legal-link-header">Legal & Policies</a>

  </div>
</header>


<div class="page-wrapper">

  <main>

    <div class="image-section">

      <div id="main-skeleton" class="skeleton"></div>

      <img id="download-image" src="" alt="Selected Image" loading="lazy" class="image-load">
      <h2 id="image-name">Loading...</h2>

      <div class="image-actions">
        <button class="info-btn"><i class="fas fa-info-circle"></i> Info</button>

        <a id="download-link" href="#" download>
          <button class="download-btn"><i class="fas fa-download"></i> Download</button>
        </a>
      </div>
    </div>

    <!-- ⭐ Updated Keywords Block -->
    <div class="keywords" id="keywords"></div>

  </main>
</div>

<div class="related-section">
    <h2>Related Images</h2>

    <div class="masonry-grid" id="related-grid">
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
    </div>
</div>

<!-- INFO MODAL -->
<div id="infoModal" class="info-modal">
  <div class="info-content">
    <span class="close-btn">&times;</span>
    <h2>Image Information</h2>
    <ul>
      <li><strong>Name:</strong> <span id="info-name">-</span></li>
      <li><strong>Dimensions:</strong> <span id="info-dimensions">-</span></li>
      <li><strong>File Size:</strong> <span id="info-size">-</span></li>
      <li><strong>Format:</strong> <span id="info-format">-</span></li>
      <li><strong>License:</strong> Free to use for commercial and personal purposes</li>
    </ul>
  </div>
</div>


<script>
/* ---------------------------------- */
/* GLOBAL SETTINGS */
/* ---------------------------------- */
const API_BASE = "https://api.pixeora.com";

/* ---------------------------------- */
/* FIXED SEARCH REDIRECT */
/* ---------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("searchForm");
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = document.getElementById("searchInput").value.trim();
      if (q.length > 0) {
        window.location.href = `/search.html?query=${encodeURIComponent(q)}`;
      }
    });
  }
});

/* ---------------------------------- */
/* IMAGE DETAILS */
/* ---------------------------------- */

const fullSlug = window.location.pathname.split("/photo/")[1] || "";

async function loadImageDetails() {
  try {
    const res = await fetch(`${API_BASE}/api/images/slug/${fullSlug}`);
    if (!res.ok) {
      document.getElementById("image-name").textContent = "Image Not Found.";
      return;
    }

    const img = await res.json();

    const displayUrl = `https://cdn.pixeora.com/${encodeURIComponent(img.fileName)}`;
    const mainImg = document.getElementById("download-image");

    mainImg.onload = () => {
      document.getElementById("main-skeleton").style.display = "none";
      mainImg.classList.add("image-loaded");
    };

    mainImg.src = displayUrl;
    document.getElementById("image-name").textContent = img.title || img.fileName;

    document.getElementById("download-link").href =
      `${API_BASE}/api/images/download/${encodeURIComponent(img.fileName)}`;

    window.__originalFileName = img.fileName;

    /* ⭐ Clean keywords */
    const keywords =
      img.keywords?.length ? img.keywords :
      img.tags?.length ? img.tags :
      [];

    document.getElementById("keywords").innerHTML =
      keywords.map(t =>
        `<span onclick="location.href='/search.html?query=${encodeURIComponent(t)}'">${t}</span>`
      ).join("");

    /* ⭐ Category + top 5 keywords */
    const bestKeywords = [
      img.category,
      ...keywords.slice(0, 5)
    ].filter(Boolean);

    startRelatedSystem(bestKeywords);

  } catch (e) {
    document.getElementById("image-name").textContent = "Image Not Found.";
  }
}

/* ---------------------------------- */
/* RELATED IMAGES — SAME STYLE AS SEARCH */
/* ---------------------------------- */

let relatedKeywordList = [];
let relatedKeywordIndex = 0;
let relatedPage = 1;
let relatedLoading = false;
let loadedIds = new Set();

function startRelatedSystem(keywords) {
  relatedKeywordList = [...new Set(keywords)];
  relatedKeywordIndex = 0;
  relatedPage = 1;
  loadedIds.clear();

  document.querySelector("#related-grid").innerHTML = `
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  `;

  loadNextKeywordBatch();
}


async function loadNextKeywordBatch() {
  if (relatedKeywordIndex >= relatedKeywordList.length) return;

  const keyword = relatedKeywordList[relatedKeywordIndex];
  relatedPage = 1;

  await loadMoreRelated(keyword);
  relatedKeywordIndex++;
}

async function loadMoreRelated(keyword) {
  if (relatedLoading) return true;
  relatedLoading = true;

  try {
    const res = await fetch(
      `${API_BASE}/api/search?q=${encodeURIComponent(keyword)}&page=${relatedPage}&limit=20`
    );

    const json = await res.json();
    const images = Array.isArray(json) ? json : json.images || [];

    const unique = images.filter(img => {
      if (!loadedIds.has(img._id)) {
        loadedIds.add(img._id);
        return true;
      }
      return false;
    });

    if (unique.length === 0) {
      relatedLoading = false;
      return false;
    }

    displayRelated(unique);

    relatedPage++;
    relatedLoading = false;
    return true;

  } catch (e) {
    relatedLoading = false;
    return false;
  }
}

function displayRelated(images) {
  const cols = document.querySelectorAll("#related-grid .masonry-col");
  if (!cols.length) return;

  let colIndex = 0;

  images.forEach((img) => {

    const thumb =
      img.thumbnailUrl ||
      (img.thumbnailFileName
        ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
        : `https://cdn.pixeora.com/${encodeURIComponent(img.fileName)}`);

    const card = document.createElement("div");
    card.classList.add("image-item");

    card.innerHTML = `
      <div class="image-wrapper" style="position:relative;">
        <div class="skeleton"></div>

        <a href="/photo/${img.slug}-${img._id}">
          <img 
            data-src="${thumb}"
            class="lazy-img image-load"
            alt="${img.alt || img.title}"
          >
        </a>

        <span class="download-overlay"></span>
      </div>
    `;

    cols[colIndex].appendChild(card);
    colIndex = (colIndex + 1) % cols.length;
  });

  lazyLoadInit();
}


/* ---------------------------------- */
/* INFINITE SCROLL */
/* ---------------------------------- */
window.addEventListener("scroll", async () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 400) {
    const keyword = relatedKeywordList[relatedKeywordIndex - 1];
    const more = await loadMoreRelated(keyword);

    if (!more) {
      loadNextKeywordBatch();
    }
  }
});

/* ---------------------------------- */
/* LAZY LOAD INIT */
/* ---------------------------------- */
function lazyLoadInit() {
  const lazyImages = document.querySelectorAll("img.lazy-img");

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;

        const img = entry.target;
        img.src = img.dataset.src;

        img.onload = () => {
          img.classList.add("image-loaded");
          img.closest(".image-wrapper").querySelector(".skeleton").remove();
        };

        img.classList.remove("lazy-img");
        obs.unobserve(img);
      });
    },
    { rootMargin: "400px 0px" }
  );

  lazyImages.forEach(img => observer.observe(img));
}

/* ---------------------------------- */
/* INFO MODAL */
/* ---------------------------------- */
const modal = document.getElementById("infoModal");
const infoBtn = document.querySelector(".info-btn");
const closeBtn = document.querySelector(".close-btn");

infoBtn.onclick = async () => {
  modal.classList.add("active");

  const originalUrl = `https://cdn.pixeora.com/${encodeURIComponent(window.__originalFileName)}`;
  document.getElementById("info-name").textContent =
    document.getElementById("image-name").textContent;

  try {
    const tmp = new Image();
    tmp.src = originalUrl;
    await tmp.decode();

    document.getElementById("info-dimensions").textContent =
      `${tmp.naturalWidth} × ${tmp.naturalHeight}px`;

    const head = await fetch(originalUrl, { method: "HEAD" });
    const size = head.headers.get("content-length");

    document.getElementById("info-size").textContent =
      size ? (size / (1024 * 1024)).toFixed(2) + " MB" : "Unknown";

    const ext = originalUrl.split(".").pop().split("?")[0].toUpperCase();
    document.getElementById("info-format").textContent = ext;

  } catch (e) {
    document.getElementById("info-dimensions").textContent = "-";
    document.getElementById("info-size").textContent = "-";
    document.getElementById("info-format").textContent = "-";
  }
};

closeBtn.onclick = () => modal.classList.remove("active");
window.onclick = (e) => { if (e.target === modal) modal.classList.remove("active"); };

loadImageDetails();
</script>
