  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- =========================
        DYNAMIC SEO (Controlled by JS)
    ========================== -->
    <title id="seo-title">Pixeora Photo</title>

    <meta id="seo-desc" name="description" content="Download high-quality HD wallpapers & royalty-free stock images for free.">
    <meta id="seo-keywords" name="keywords"
          content="free hd wallpaper download, 4k image download, stock photo download, royalty free images, commercial use photos, aesthetic backgrounds, nature wallpapers, abstract wallpapers, USA UK Canada Australia India wallpaper download">

    <!-- Canonical (dynamic by JS) -->
    <link id="canonical-link" rel="canonical" href="">

    <!-- =========================
        PERFORMANCE BOOST
    ========================== -->
    <link rel="preload" href="/css/download.css" as="style">
    <link rel="stylesheet" href="/css/download.css">
    <link rel="stylesheet" href="css/cookie.css">

    <link rel="preconnect" href="https://cdn.pixeora.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.pixeora.com">

    <link rel="preconnect" href="https://api.pixeora.com" crossorigin>
    <link rel="dns-prefetch" href="https://api.pixeora.com">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Marck+Script&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- =========================
        SOCIAL SHARING (Dynamic OG Tags)
    ========================== -->
    <meta id="og-title" property="og:title" content="Pixeora Image">
    <meta id="og-desc" property="og:description" content="Download full HD wallpapers & royalty-free stock images.">
    <meta id="og-image" property="og:image" content="">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Pixeora">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta id="twitter-title" name="twitter:title" content="Pixeora Image Download">
    <meta id="twitter-desc" name="twitter:description" content="Download high-quality wallpapers, 4K backgrounds, and stock images.">
    <meta id="twitter-image" name="twitter:image" content="">

    <!-- =========================
        STRUCTURED DATA (Dynamic ImageObject)
        Boosts Google Image ranking!
    ========================== -->
    <script type="application/ld+json" id="ld-json">
    {
      "@context": "https://schema.org",
      "@type": "ImageObject",
      "name": "",
      "description": "",
      "contentUrl": "",
      "thumbnailUrl": "",
      "creator": {
        "@type": "Organization",
        "name": "Pixeora"
      },
      "license": "https://pixeora.com/license"
    }
    </script>

  </head>

<body>

<header class="header">
  <div class="header-overlay">

    <a href="/index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" id="searchForm">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="/images/search-icon.png" alt="Search" loading="lazy">
          </button>
        </form>
      </div>
    </div>

    <a href="/legal.html" class="legal-link-header">Legal & Policies</a>

  </div>
</header>


<div class="page-wrapper">

  <main>

    <div class="image-section">

      <div id="main-skeleton" class="skeleton"></div>

      <img id="download-image" src="" alt="Selected Image" loading="lazy" class="image-load">
      <h2 id="image-name">Loading...</h2>

      <div class="image-actions">
        <button class="info-btn"><i class="fas fa-info-circle"></i> Info</button>

        <a id="download-link" href="#" download>
          <button class="download-btn"><i class="fas fa-download"></i> Download</button>
        </a>
      </div>
    </div>

    <!-- ⭐ Updated Keywords Block -->
    <div class="keywords" id="keywords"></div>

  </main>
</div>

<div class="related-wrapper">
    <h2>Related Images</h2>

    <div class="masonry-grid" id="related-grid">
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
    </div>
</div>

<!-- INFO MODAL -->
<div id="infoModal" class="info-modal">
  <div class="info-content">
    <span class="close-btn">&times;</span>
    <h2>Image Information</h2>
    <ul>
      <li><strong>Name:</strong> <span id="info-name">-</span></li>
      <li><strong>Dimensions:</strong> <span id="info-dimensions">-</span></li>
      <li><strong>File Size:</strong> <span id="info-size">-</span></li>
      <li><strong>Format:</strong> <span id="info-format">-</span></li>
      <li><strong>License:</strong> Free to use for commercial and personal purposes</li>
    </ul>
  </div>
</div>

<div id="cookie-banner" class="premium-cookie">
  <div class="cookie-content">
    <p class="cookie-message">
      We use cookies to enhance your browsing experience and analyze traffic.
    </p>
    <button id="cookie-accept" class="cookie-btn-premium">Got it</button>
  </div>
</div>


<script>
/* ---------------------------------- */
/* GLOBAL SETTINGS */
/* ---------------------------------- */
const API_BASE = "https://api.pixeora.com";

/* ---------------------------------- */
/* FIXED SEARCH REDIRECT */
/* ---------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("searchForm");
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = document.getElementById("searchInput").value.trim();
      if (q.length > 0) {
        window.location.href = `/search.html?query=${encodeURIComponent(q)}`;
      }
    });
  }
});

function downloadImage(rawName) {
  const url = `${API_BASE}/api/images/download/${encodeURIComponent(rawName)}`;
  window.location.href = url;
}

/* ---------------------------------- */
/* SUBJECT DETECTION FROM TITLE */
/* ---------------------------------- */
function detectMainSubject(title) {
  if (!title) return "";

  const t = title.toLowerCase();

  const map = [
    ["tiger", "tiger"], ["lion", "lion"], ["cat", "cat"], ["dog", "dog"],
    ["elephant", "elephant"], ["wolf", "wolf"], ["bear", "bear"],
    ["horse", "horse"],

    // birds
    ["bird", "bird"], ["duck", "bird"], ["eagle", "bird"],
    ["sparrow", "bird"], ["parrot", "bird"],

    // fish & ocean
    ["fish", "fish"], ["ocean", "fish"], ["underwater", "fish"],
    ["sea", "fish"], ["coral", "fish"],

    // city / architecture
    ["bridge", "bridge"], ["building", "architecture"],
    ["architecture", "architecture"], ["city", "architecture"],

    // landscape
    ["mountain", "mountain"], ["river", "river"], ["lake", "lake"],
    ["waterfall", "waterfall"], ["forest", "forest"],

    // people / portraits
    ["girl", "portrait"], ["woman", "portrait"], ["man", "portrait"],
    ["kid", "portrait"],  ["face", "portrait"], ["people", "portrait"],
  ];

  for (let [word, subject] of map) {
    if (t.includes(word)) return subject;
  }

  return "";
}

/* ---------------------------------- */
/* UNIVERSAL ID + SLUG EXTRACTOR     */
/* ---------------------------------- */

const rawSlug = window.location.pathname.split("/photo/")[1] || "";

/* Extract MongoID (last 24 hex chars) */
const idMatch = rawSlug.match(/([a-f0-9]{24})$/i);
const imageId = idMatch ? idMatch[1] : null;

/* Extract slug part before ID */
let slug = rawSlug.replace(/-[a-f0-9]{24}$/i, "");

/* Handle old 'undefined-<id>' cases */
if (
  !slug ||
  slug.trim() === "" ||
  slug === "undefined" ||
  slug === "null"
) {
  slug = null;
}

console.log("Slug =", slug);
console.log("ImageID =", imageId);
console.log("RawSlug =", rawSlug);


/* ---------------------------------- */
/* IMAGE DETAILS — Thumbnail → HD     */
/* ---------------------------------- */
async function loadImageDetails() {
  try {
    let apiList = [];

    // Priority 1: slug-ID full (always correct)
    if (rawSlug) {
      apiList.push(`${API_BASE}/api/images/slug/${rawSlug}`);
    }

    // Priority 2: ID only
    if (imageId) {
      apiList.push(`${API_BASE}/api/images/slug/${imageId}`);
    }

    // Priority 3: slug only (rarely needed)
    if (slug) {
      apiList.push(`${API_BASE}/api/images/slug/${slug}`);
    }

    console.log("Trying API List:", apiList);

    let img = null;

    for (let url of apiList) {
      const res = await fetch(url);
      if (res.ok) {
        img = await res.json();
        console.log("Loaded From:", url);
        break;
      }
    }

    if (!img) {
      document.getElementById("image-name").textContent = "Image Not Found.";
      return;
    }

    const file = encodeURIComponent(img.fileName);

    /* ---------------------------------------- */
    /* CDN PATHS                                */
    /* ---------------------------------------- */
    const thumbUrl = img.thumbnailFileName
      ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
      : `https://cdn.pixeora.com/thumbs/${file}`;

    const originalUrl = `https://cdn.pixeora.com/${file}`;

    const mainImg = document.getElementById("download-image");
    const skeleton = document.getElementById("main-skeleton");

    /* ---------------------------------------- */
    /* THUMBNAIL → BLUR → HD IMAGE              */
    /* ---------------------------------------- */
    mainImg.src = thumbUrl;
    mainImg.style.filter = "blur(3px)";
    mainImg.style.opacity = "0.2";
    skeleton.style.display = "none";

    const hd = new Image();
    hd.src = originalUrl;

    hd.onload = () => {
      mainImg.src = originalUrl;
      mainImg.style.transition = "filter .4s ease, opacity .3s ease";
      mainImg.style.filter = "blur(0px)";
      mainImg.style.opacity = "1";

      if (hd.naturalWidth && hd.naturalHeight) {
        mainImg.style.aspectRatio = `${hd.naturalWidth}/${hd.naturalHeight}`;
      }
    };

    hd.onerror = () => console.warn("❌ HD image missing:", originalUrl);

    /* ---------------------------------------- */
    /* TITLE + DOWNLOAD BUTTON                  */
    /* ---------------------------------------- */
    document.getElementById("image-name").textContent =
      img.title || img.fileName;

    document.getElementById("download-link").href =
      `${API_BASE}/api/images/download/${file}`;

    window.__originalFileName = img.fileName;

    /* ---------------------------------------- */
    /* KEYWORDS                                 */
    /* ---------------------------------------- */
    const keywords =
      img.keywords?.length
        ? img.keywords
        : img.tags?.length
        ? img.tags
        : [];

    document.getElementById("keywords").innerHTML = keywords
      .map(
        (t) =>
          `<span onclick="location.href='/search.html?query=${encodeURIComponent(
            t
          )}'">${t}</span>`
      )
      .join("");

    /* ---------------------------------------- */
    /* RELATED SYSTEM                           */
    /* ---------------------------------------- */
    const subject = detectMainSubject(img.title || "");
    startRelatedSystem([subject, img.category, ...keywords.slice(0, 6)].filter(Boolean));

  } catch (err) {
    console.error("Loader Error:", err);
    document.getElementById("image-name").textContent = "Image Not Found.";
  }
}


/* ---------------------------------- */
/* RELATED SYSTEM — UPDATED */
/* ---------------------------------- */

let relatedKeywordList = [];
let relatedKeywordIndex = 0;
let relatedPage = 1;
let relatedLoading = false;
let loadedIds = new Set();

function startRelatedSystem(keywords) {
  if (!keywords || keywords.length === 0) return;

  const mainSubject = keywords[0]?.toLowerCase() || "";

  const strongWords = [
    "tiger","lion","cat","dog","elephant","wolf","bear","horse",
    "bird","fish","bridge","architecture","mountain","river",
    "waterfall","forest","portrait","face","people"
  ];

  const strongMatches = [];
  const mediumMatches = [];
  const weakMatches = [];

  keywords.forEach(k => {
    const kw = k.toLowerCase();

    if (mainSubject && kw.includes(mainSubject)) {
      strongMatches.push(k);   // PERFECT MATCH
    }
    else if (strongWords.some(sw => kw.includes(sw))) {
      mediumMatches.push(k);   // GOOD MATCH
    }
    else {
      weakMatches.push(k);     // OTHER
    }
  });

  relatedKeywordList = [...new Set([
    ...strongMatches,
    ...mediumMatches,
    ...weakMatches
  ])];

  relatedKeywordIndex = 0;
  relatedPage = 1;
  loadedIds.clear();

  document.querySelector("#related-grid").innerHTML = `
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  `;

  loadNextKeywordBatch();
}

/* ---------------------------------- */
/* LOADING RELATED IMAGES */
/* ---------------------------------- */

async function loadNextKeywordBatch() {
  if (relatedKeywordIndex >= relatedKeywordList.length) return;
  const keyword = relatedKeywordList[relatedKeywordIndex];
  relatedPage = 1;

  await loadMoreRelated(keyword);
  relatedKeywordIndex++;
}

async function loadMoreRelated(keyword) {
  if (relatedLoading) return true;
  relatedLoading = true;

  try {
    const res = await fetch(
      `${API_BASE}/api/search?q=${encodeURIComponent(keyword)}&page=${relatedPage}&limit=20`
    );

    const json = await res.json();
    const images = Array.isArray(json) ? json : json.images || [];

    const unique = images.filter(img => {
      if (!loadedIds.has(img._id)) {
        loadedIds.add(img._id);
        return true;
      }
      return false;
    });

    if (unique.length === 0) {
      relatedLoading = false;
      return false;
    }

    displayRelated(unique);

    relatedPage++;
    relatedLoading = false;
    return true;

  } catch (e) {
    relatedLoading = false;
    return false;
  }
}

function displayRelated(images) {
  const cols = document.querySelectorAll("#related-grid .masonry-col");
  if (!cols.length) return;

  let colIndex = 0;

  images.forEach((img) => {
    const thumb =
      img.thumbnailUrl ||
      (img.thumbnailFileName
        ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
        : `https://cdn.pixeora.com/${encodeURIComponent(img.fileName)}`);

    const card = document.createElement("div");
    card.classList.add("image-item");

    card.innerHTML = `
      <div class="image-wrapper" style="position:relative;">
        <div class="skeleton"></div>

        <a href="/photo/${img.slug}-${img._id}" class="image-link">
          <img 
            data-src="${thumb}"
            class="lazy-img blur-load"
            alt="${img.alt || img.title}"
            loading="lazy"
            decoding="async"
          />
        </a>

        <span class="download-overlay"
          onclick="event.stopImmediatePropagation(); event.preventDefault(); downloadImage('${img.fileName.replace(/'/g, "\\'")}')">
        </span>
      </div>
    `;

    cols[colIndex].appendChild(card);
    colIndex = (colIndex + 1) % cols.length;
  });

  lazyLoadInit();
}



/* ---------------------------------- */
/* INFINITE SCROLL */
/* ---------------------------------- */
window.addEventListener("scroll", async () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 400) {
    const keyword = relatedKeywordList[relatedKeywordIndex - 1];
    const more = await loadMoreRelated(keyword);

    if (!more) {
      loadNextKeywordBatch();
    }
  }
});

/* ---------------------------------- */
/* LAZY LOAD INIT */
/* ---------------------------------- */
function lazyLoadInit() {
  const lazyImages = document.querySelectorAll("img.lazy-img");

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;

        const img = entry.target;
        img.src = img.dataset.src;

        img.onload = () => {
          img.classList.add("image-loaded");
          img.closest(".image-wrapper").querySelector(".skeleton").remove();
        };

        img.classList.remove("lazy-img");
        obs.unobserve(img);
      });
    },
    { rootMargin: "400px 0px" }
  );

  lazyImages.forEach(img => observer.observe(img));
}

/* ---------------------------------- */
/* INFO MODAL */
/* ---------------------------------- */
const modal = document.getElementById("infoModal");
const infoBtn = document.querySelector(".info-btn");
const closeBtn = document.querySelector(".close-btn");

infoBtn.onclick = async () => {
  modal.classList.add("active");

  const originalUrl = `https://cdn.pixeora.com/${encodeURIComponent(window.__originalFileName)}`;
  document.getElementById("info-name").textContent =
    document.getElementById("image-name").textContent;

  try {
    const tmp = new Image();
    tmp.src = originalUrl;
    await tmp.decode();

    document.getElementById("info-dimensions").textContent =
      `${tmp.naturalWidth} × ${tmp.naturalHeight}px`;

    const head = await fetch(originalUrl, { method: "HEAD" });
    const size = head.headers.get("content-length");

    document.getElementById("info-size").textContent =
      size ? (size / (1024 * 1024)).toFixed(2) + " MB" : "Unknown";

    const ext = originalUrl.split(".").pop().split("?")[0].toUpperCase();
    document.getElementById("info-format").textContent = ext;

  } catch (e) {
    document.getElementById("info-dimensions").textContent = "-";
    document.getElementById("info-size").textContent = "-";
    document.getElementById("info-format").textContent = "-";
  }
};

closeBtn.onclick = () => modal.classList.remove("active");
window.onclick = (e) => { if (e.target === modal) modal.classList.remove("active"); };

loadImageDetails();

document.addEventListener("DOMContentLoaded", function () {
  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("cookie-accept");

  if (!localStorage.getItem("cookieConsent")) {
    setTimeout(() => {
      banner.classList.add("show");
    }, 500);
  }

  acceptBtn.addEventListener("click", () => {
    localStorage.setItem("cookieConsent", "true");
    banner.classList.remove("show");
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("cookie-accept");

  if (!localStorage.getItem("cookieConsent")) {
    setTimeout(() => {
      banner.classList.add("show");
    }, 500);
  }

  acceptBtn.addEventListener("click", () => {
    localStorage.setItem("cookieConsent", "true");
    banner.classList.remove("show");
  });
});

</script>

  