<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- =========================
      SEO + INDEXING (corrected)
  ========================== -->
  <meta name="robots" content="index, follow">

  <title id="seo-title">Pixeora Photo</title>

  <meta name="pinterest-rich-pin" content="false" />
  <meta id="seo-desc" name="description" content="Download high-quality HD wallpapers & royalty-free stock images for free.">
  <meta id="seo-keywords" name="keywords"
        content="free hd wallpaper download, 4k image download, stock photo download, royalty free images, commercial use images, aesthetic backgrounds, nature wallpapers, abstract wallpapers, USA UK Canada Australia India wallpaper download">

  <!-- Canonical (dynamic update later) -->
  <link id="canonical-link" rel="canonical" href="https://pixeora.com/photo/">

  <!-- =========================
      FAVICONS
  ========================== -->
  <link rel="icon" type="image/png" sizes="192x192" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="apple-touch-icon" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#000000">

  <!-- =========================
      PERFORMANCE BOOST
  ========================== -->
  <link rel="preload" href="/css/download.css" as="style">
  <link rel="stylesheet" href="/css/download.css">
  <link rel="stylesheet" href="/css/cookie.css">

  <link rel="preconnect" href="https://cdn.pixeora.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.pixeora.com">

  <link rel="preconnect" href="https://api.pixeora.com" crossorigin>
  <link rel="dns-prefetch" href="https://api.pixeora.com">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Marck+Script&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <!-- =========================
      SOCIAL SHARING META
  ========================== -->
  <meta id="og-title" property="og:title" content="Pixeora â€“ Free HD Image">
  <meta id="og-desc" property="og:description" content="Download full HD wallpapers & royalty-free stock images.">
  <meta id="og-image" property="og:image" content="https://pixeora.com/images/logo.png">
  <meta property="og:url" id="og-url" content="">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="Pixeora">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta id="twitter-title" name="twitter:title" content="Pixeora â€“ Free HD Image Download">
  <meta id="twitter-desc" name="twitter:description" content="Download high-quality wallpapers, 4K backgrounds, and stock images.">
  <meta id="twitter-image" name="twitter:image" content="https://pixeora.com/images/logo.png">


  <!-- =========================
      STRUCTURED DATA (Dynamic ImageObject)
  ========================== -->
  <script type="application/ld+json" id="ld-json">
  {
    "@context": "https://schema.org",
    "@type": "ImageObject",
    "name": "",
    "description": "",
    "contentUrl": "",
    "thumbnailUrl": "",
    "creator": {
      "@type": "Organization",
      "name": "Pixeora"
    },
    "license": "https://pixeora.com/license"
  }
  </script>

  <!-- =========================
      LOGO SCHEMA
  ========================== -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Pixeora",
    "url": "https://pixeora.com",
    "logo": "https://pixeora.com/images/logo.png"
  }
  </script>


  <!-- =========================
      FIXED PINTEREST / SOCIAL PREVIEW
      (removed buggy img.fileName reference)
  ========================== -->
  <script>
  (function () {
    const slug = window.location.pathname.split("/photo/")[1];
    if (!slug) return;

    const idMatch = slug.match(/([a-f0-9]{24})$/i);
    if (!idMatch) return;

    // OG URL must always update first
    document.getElementById("og-url")?.setAttribute("content", window.location.href);
  })();
  </script>

  <!-- =========================
      NOSCRIPT FALLBACK (SEO + users)
  ========================== -->
  <noscript>
    <meta name="robots" content="index, follow">
    <div style="padding:10px;background:#111;color:#fff;text-align:center;font-size:14px;">
      JavaScript is disabled. Image preview may not load, but you can still access files.
    </div>
  </noscript>

</head>

<body>

<header class="header">
  <div class="header-overlay">

    <a href="/index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" id="searchForm">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="/images/search-icon.png" alt="Search" loading="lazy">
          </button>
        </form>
      </div>
    </div>

    <a href="/legal.html" class="legal-link-header">Legal & Policies</a>

  </div>
</header>


<div class="page-wrapper">

  <main>

    <div class="image-section">

      <div id="main-skeleton" class="skeleton"></div>

      <!-- ðŸ”’ PROTECTED IMAGE WRAPPER -->
      <div class="protected-wrapper" style="position:relative; display:inline-block; width:100%;">

        <img id="download-image"
             src=""
             alt="Selected Image"
             loading="lazy"
             class="image-load protected-img">

        <!-- Invisible Click-Blocker -->
        <div id="image-protect-overlay"></div>

      </div>
      <!-- END PROTECTED WRAPPER -->

      <h2 id="image-name">Loading...</h2>

      <div class="image-actions">
        <button class="info-btn"><i class="fas fa-info-circle"></i> Info</button>

        <a id="download-link" href="#" download>
          <button class="download-btn"><i class="fas fa-download"></i> Download</button>
        </a>
      </div>
    </div>

    <!-- â­ Updated Keywords Block -->
    <div class="keywords" id="keywords"></div>


  </main>
</div>

<div class="related-wrapper">
    <h2>Related Images</h2>

    <div class="masonry-grid" id="related-grid">
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
        <div class="masonry-col"></div>
    </div>
</div>

<!-- INFO MODAL -->
<div id="infoModal" class="info-modal">
  <div class="info-content">
    <span class="close-btn">&times;</span>
    <h2>Image Information</h2>
    <ul>
      <li><strong>Name:</strong> <span id="info-name">-</span></li>
      <li><strong>Dimensions:</strong> <span id="info-dimensions">-</span></li>
      <li><strong>File Size:</strong> <span id="info-size">-</span></li>
      <li><strong>Format:</strong> <span id="info-format">-</span></li>
      <li><strong>License:</strong> Free to use for commercial and personal purposes</li>
    </ul>
  </div>
</div>

<div id="cookie-banner" class="premium-cookie">
  <div class="cookie-content">
    <p class="cookie-message">
      We use cookies to enhance your browsing experience and analyze traffic.
    </p>
    <button id="cookie-accept" class="cookie-btn-premium">Got it</button>
  </div>
</div>

<script>
/* ---------------------------------- */
/* GLOBAL SETTINGS */
/* ---------------------------------- */
const API_BASE = "https://api.pixeora.com";

/* ---------------------------------- */
/* SUBJECT DETECTION */
/* ---------------------------------- */
function detectMainSubject(title) {
  if (!title) return "";
  const t = title.toLowerCase();

  const map = [
    ["tiger","tiger"],["lion","lion"],["cat","cat"],["dog","dog"],
    ["elephant","elephant"],["wolf","wolf"],["bear","bear"],["horse","horse"],
    ["bird","bird"],["duck","bird"],["eagle","bird"],["sparrow","bird"],["parrot","bird"],
    ["fish","fish"],["ocean","fish"],["underwater","fish"],["sea","fish"],["coral","fish"],
    ["bridge","bridge"],["building","architecture"],["architecture","architecture"],["city","architecture"],
    ["mountain","mountain"],["river","river"],["lake","lake"],["waterfall","waterfall"],["forest","forest"],
    ["girl","portrait"],["woman","portrait"],["man","portrait"],["kid","portrait"],["face","portrait"],["people","portrait"],
  ];

  for (let [word, subject] of map) {
    if (t.includes(word)) return subject;
  }
  return "";
}

/* ---------------------------------- */
/* UNIVERSAL ID + SLUG */
/* ---------------------------------- */
const rawSlug = window.location.pathname.split("/photo/")[1] || "";
const idMatch = rawSlug.match(/([a-f0-9]{24})$/i);
const imageId = idMatch ? idMatch[1] : null;
let slug = rawSlug.replace(/-[a-f0-9]{24}$/i, "");

if (!slug || slug.trim() === "" || slug === "undefined" || slug === "null") {
  slug = null;
}

/* ---------------------------------- */
/* DOWNLOAD HELPER (CDN-first, non-blocking tracking) */
/* ---------------------------------- */
async function downloadImage(rawName) {
  try {
    const file = encodeURIComponent(rawName);
    const cdn = `https://cdn.pixeora.com/${file}`;

    // Fire-and-forget tracking (do not block navigation)
    fetch(`${API_BASE}/api/images/track-download/${file}`, { method: 'POST' })
      .catch(() => { /* ignore errors */ });

    // Navigate to CDN (this is crawlable behavior equivalent to anchor href)
    window.location.href = cdn;
  } catch (e) {
    // fallback to API route if something unexpected happens
    const fallback = `${API_BASE}/api/images/download/${encodeURIComponent(rawName)}`;
    window.location.href = fallback;
  }
}

/* ---------------------------------- */
/* LOAD IMAGE DETAILS */
/* ---------------------------------- */
async function loadImageDetails() {
  try {
    let apiList = [];

    if (rawSlug) apiList.push(`${API_BASE}/api/images/slug/${rawSlug}`);
    if (imageId) apiList.push(`${API_BASE}/api/images/slug/${imageId}`);
    if (slug) apiList.push(`${API_BASE}/api/images/slug/${slug}`);

    let img = null;

    for (let url of apiList) {
      const res = await fetch(url);
      if (res.ok) {
        img = await res.json();
        break;
      }
    }

    if (!img) {
      document.getElementById("image-name").textContent = "Image Not Found.";
      return;
    }

    /* CDN URLs */
    const file = encodeURIComponent(img.fileName);
    const thumbUrl = img.thumbnailFileName
      ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
      : `https://cdn.pixeora.com/thumbs/${file}`;

    const originalUrl = `https://cdn.pixeora.com/${file}`;

    const mainImg = document.getElementById("download-image");
    const skeleton = document.getElementById("main-skeleton");

    /* Show blurred thumbnail first */
    mainImg.src = thumbUrl;
    mainImg.style.filter = "blur(3px)";
    mainImg.style.opacity = "0.2";
    skeleton.style.display = "none";

    const hd = new Image();
    hd.src = originalUrl;

    hd.onload = () => {
      mainImg.src = originalUrl;
      mainImg.style.transition = "filter .4s ease, opacity .3s ease";
      mainImg.style.filter = "blur(0px)";
      mainImg.style.opacity = "1";

      if (hd.naturalWidth && hd.naturalHeight) {
        mainImg.style.aspectRatio = `${hd.naturalWidth}/${hd.naturalHeight}`;
      }
    };

    /* Update title + download */
    document.getElementById("image-name").textContent =
      img.title || img.fileName;

    /* --------- IMPORTANT: set direct CDN anchor (crawlable) --------- */
    const downloadAnchor = document.getElementById("download-link");
    if (downloadAnchor) {
      downloadAnchor.setAttribute("href", originalUrl);
      // Suggest filename on save
      downloadAnchor.setAttribute("download", img.fileName || "");
      // Ensure crawler sees a normal link
      downloadAnchor.removeAttribute("rel");
    }

    window.__originalFileName = img.fileName;

    /* Add a non-blocking tracking handler to visible button (does not change anchor behavior) */
    const downloadBtn = document.querySelector(".download-btn");
    if (downloadBtn) {
      // remove any existing handler to avoid duplicates
      downloadBtn.onclick = null;
      downloadBtn.addEventListener("click", function () {
        // Track click but do not prevent default anchor navigation
        try {
          navigator.sendBeacon
            ? navigator.sendBeacon(`${API_BASE}/api/images/track-click/${encodeURIComponent(img._id)}`)
            : fetch(`${API_BASE}/api/images/track-click/${encodeURIComponent(img._id)}`, { method: "POST" }).catch(()=>{});
        } catch (e) { /* ignore tracking errors */ }
        // Allow normal anchor click/navigation to proceed
      }, { passive: true });
    }

    /* OG / Twitter Meta */
    document.getElementById("og-title").setAttribute("content", img.title || "");
    document.getElementById("og-desc").setAttribute("content", img.description || "");
    document.getElementById("og-image").setAttribute("content", originalUrl);
    document.getElementById("og-url").setAttribute("content", window.location.href);

    document.getElementById("twitter-title").setAttribute("content", img.title || "");
    document.getElementById("twitter-desc").setAttribute("content", img.description || "");
    document.getElementById("twitter-image").setAttribute("content", originalUrl);

    document.getElementById("canonical-link").setAttribute("href", window.location.href);

    /* Schema */
    document.getElementById("ld-json").textContent = JSON.stringify({
      "@context": "https://schema.org",
      "@type": "ImageObject",
      "name": img.title,
      "description": img.description,
      "contentUrl": originalUrl,
      "thumbnailUrl": thumbUrl,
      "creator": { "@type": "Organization", "name": "Pixeora" },
      "license": "https://pixeora.com/license"
    });

    /* Keywords */
    const keywords =
      img.keywords?.length ? img.keywords :
      img.tags?.length ? img.tags : [];

    document.getElementById("keywords").innerHTML = keywords
      .map(t => `<span onclick="location.href='/search.html?query=${encodeURIComponent(t)}'">${t}</span>`)
      .join("");

    /* RELATED IMAGES */
    const subject = detectMainSubject(img.title || "");
    startRelatedSystem([subject, img.category, ...keywords.slice(0, 6)].filter(Boolean));

  } catch (err) {
    console.error("Loader Error:", err);
    document.getElementById("image-name").textContent = "Image Not Found.";
  }
}

/* ---------------------------------- */
/* RELATED SYSTEM â€“ CLEANED */
/* ---------------------------------- */
let relatedKeywordList = [];
let relatedKeywordIndex = 0;
let relatedPage = 1;
let relatedLoading = false;
let loadedIds = new Set();

function startRelatedSystem(keywords) {
  if (!keywords || keywords.length === 0) return;

  const strongWords = [
    "tiger","lion","cat","dog","elephant","wolf","bear","horse",
    "bird","fish","bridge","architecture","mountain","river",
    "waterfall","forest","portrait","face","people"
  ];

  const main = keywords[0]?.toLowerCase() || "";

  const strong = [];
  const medium = [];
  const weak = [];

  keywords.forEach(k => {
    const kw = k.toLowerCase();
    if (main && kw.includes(main)) strong.push(k);
    else if (strongWords.some(sw => kw.includes(sw))) medium.push(k);
    else weak.push(k);
  });

  relatedKeywordList = [...new Set([...strong, ...medium, ...weak])];
  relatedKeywordIndex = 0;
  relatedPage = 1;
  loadedIds.clear();

  const grid = document.querySelector("#related-grid");
  grid.innerHTML = `
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  `;

  window.relatedCols = Array.from(grid.querySelectorAll(".masonry-col"));

  loadNextKeywordBatch();
}

async function loadNextKeywordBatch() {
  if (relatedKeywordIndex >= relatedKeywordList.length) return;
  const keyword = relatedKeywordList[relatedKeywordIndex];
  relatedPage = 1;
  await loadMoreRelated(keyword);
  relatedKeywordIndex++;
}

async function loadMoreRelated(keyword) {
  if (relatedLoading) return true;
  relatedLoading = true;

  try {
    const res = await fetch(
      `${API_BASE}/api/search?q=${encodeURIComponent(keyword)}&page=${relatedPage}&limit=20`
    );

    const json = await res.json();
    const images = Array.isArray(json) ? json : json.images || [];

    const unique = images.filter(img => {
      if (!loadedIds.has(img._id)) {
        loadedIds.add(img._id);
        return true;
      }
      return false;
    });

    if (unique.length === 0) {
      relatedLoading = false;
      return false;
    }

    displayRelated(unique);
    relatedPage++;

    relatedLoading = false;
    return true;

  } catch (e) {
    relatedLoading = false;
    return false;
  }
}

function displayRelated(images) {
  const cols = window.relatedCols;
  if (!cols.length) return;

  let colIndex = 0;

  images.forEach((img) => {
    const thumb = img.thumbnailUrl ||
      (img.thumbnailFileName
        ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
        : `https://cdn.pixeora.com/${encodeURIComponent(img.fileName)}`);

    const card = document.createElement("div");
    card.classList.add("image-item");

    card.innerHTML = `
      <div class="image-wrapper" style="position:relative;">
        <div class="skeleton"></div>

        <a href="/photo/${img.slug}-${img._id}" class="image-link">
          <img 
            data-src="${thumb}"
            class="lazy-img blur-load"
            alt="${img.alt || img.title}"
            loading="lazy"
            decoding="async"
          />
        </a>

        <span class="download-overlay"
          onclick="event.stopImmediatePropagation(); event.preventDefault(); downloadImage('${img.fileName.replace(/'/g, "\\'")}')">
        </span>
      </div>
    `;

    cols[colIndex].appendChild(card);
    colIndex = (colIndex + 1) % cols.length;
  });

  lazyLoadInit();
}

/* ---------------------------------- */
/* INFINITE SCROLL */
/* ---------------------------------- */
window.addEventListener("scroll", async () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 400) {
    const keyword = relatedKeywordList[relatedKeywordIndex - 1];
    const more = await loadMoreRelated(keyword);
    if (!more) {
      // Try next keyword until something loads
      while (relatedKeywordIndex < relatedKeywordList.length) {
        const nextKeyword = relatedKeywordList[relatedKeywordIndex++];
        const loaded = await loadMoreRelated(nextKeyword);
        if (loaded) break;
      }
    } 
  }
});

/* ---------------------------------- */
/* LAZY LOADING */
/* ---------------------------------- */
function lazyLoadInit() {
  const lazyImages = document.querySelectorAll("img.lazy-img");

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;

        const img = entry.target;
        img.src = img.dataset.src;

        img.onload = () => {
          img.classList.add("image-loaded");
          img.closest(".image-wrapper").querySelector(".skeleton").remove();
        };

        img.classList.remove("lazy-img");
        obs.unobserve(img);
      });
    },
    { rootMargin: "400px 0px" }
  );

  lazyImages.forEach(img => observer.observe(img));
}

/* ---------------------------------- */
/* INFO MODAL */
/* ---------------------------------- */
const modal = document.getElementById("infoModal");
const infoBtn = document.querySelector(".info-btn");
const closeBtn = document.querySelector(".close-btn");

infoBtn.onclick = async () => {
  modal.classList.add("active");

  const originalUrl = `https://cdn.pixeora.com/${encodeURIComponent(window.__originalFileName)}`;
  document.getElementById("info-name").textContent =
    document.getElementById("image-name").textContent;

  try {
    const tmp = new Image();
    tmp.src = originalUrl;
    await tmp.decode();

    document.getElementById("info-dimensions").textContent =
      `${tmp.naturalWidth} Ã— ${tmp.naturalHeight}px`;

    const head = await fetch(originalUrl, { method: "HEAD" });
    const size = head.headers.get("content-length");

    document.getElementById("info-size").textContent =
      size ? (size / (1024 * 1024)).toFixed(2) + " MB" : "Unknown";

    const ext = originalUrl.split(".").pop().split("?")[0].toUpperCase();
    document.getElementById("info-format").textContent = ext;

  } catch (e) {
    document.getElementById("info-dimensions").textContent = "-";
    document.getElementById("info-size").textContent = "-";
    document.getElementById("info-format").textContent = "-";
  }
};

closeBtn.onclick = () => modal.classList.remove("active");
window.onclick = (e) => { if (e.target === modal) modal.classList.remove("active"); };

/* ---------------------------------- */
/* IMAGE PROTECTION */
/* ---------------------------------- */
document.addEventListener("contextmenu", function(e) {
  if (e.target.id === "image-protect-overlay" || e.target.id === "download-image") {
    e.preventDefault();
  }
});

/* ---------------------------------- */
/* COOKIE + IMAGE LOAD + SEARCH â€” SINGLE CLEAN DOM READY */
/* ---------------------------------- */
document.addEventListener("DOMContentLoaded", function () {

  /* SEARCH FORM */
  const form = document.getElementById("searchForm");
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = document.getElementById("searchInput").value.trim();
      if (q.length > 0) {
        window.location.href = `/search.html?query=${encodeURIComponent(q)}`;
      }
    });
  }

  /* LOAD IMAGE DETAILS */
  loadImageDetails();

  /* COOKIE BANNER */
  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("cookie-accept");

  if (!localStorage.getItem("cookieConsent")) {
    setTimeout(() => banner.classList.add("show"), 500);
  }

  acceptBtn.addEventListener("click", () => {
    localStorage.setItem("cookieConsent", "true");
    banner.classList.remove("show");
  });

  /* TOUCH PROTECTION */
  const overlay = document.getElementById("image-protect-overlay");
  overlay.addEventListener("touchstart", (e) => {
    e.preventDefault();
  });

});

</script>
