<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- SEO -->
  <meta name="robots" content="index, follow">

  <title>Pixeora Photo</title>
  <meta name="description"
        content="Download high-quality HD wallpapers, 4K backgrounds and royalty-free stock images for free.">

  <!-- Pinterest verification -->
  <meta name="pinterest-rich-pin" content="true">
  <meta name="p:domain_verify" content="baeea6bc953c52f33c6f450565b4a8ab">

  <!-- âŒ DO NOT DEFINE og:image HERE -->
  <!-- OG TAGS ARE SERVED BY BACKEND OG PAGE -->

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="apple-touch-icon" href="/images/logo.png">

  <!-- Styles -->
  <link rel="preload" href="/css/download.css" as="style">
  <link rel="stylesheet" href="/css/download.css">
  <link rel="stylesheet" href="/css/cookie.css">

  <!-- Performance -->
  <link rel="preconnect" href="https://cdn.pixeora.com" crossorigin>
  <link rel="preconnect" href="https://api.pixeora.com" crossorigin>

  <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Pixeora",
    "url": "https://pixeora.com",
    "logo": "https://pixeora.com/images/logo.png"
  }
  </script>

  <!-- ðŸ¤– BOT REDIRECT (CRITICAL) -->
  <script>
  (function () {
    var ua = navigator.userAgent || "";
    var isBot =
      /facebookexternalhit|Facebot|MetaInspector|Twitterbot|Pinterestbot|Slackbot|WhatsApp|LinkedInBot|TelegramBot/i.test(ua);

    if (isBot && location.pathname.startsWith("/photo/")) {
      var slug = location.pathname.replace("/photo/", "");
      location.replace(
        "https://api.pixeora.com/photo/" + encodeURIComponent(slug)
      );
    }
  })();
  </script>

</head>

<body>

<header class="header">
  <div class="header-overlay">

    <a href="/index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" id="searchForm">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="/images/search-icon.png" alt="Search" loading="lazy">
          </button>
        </form>
      </div>
    </div>

    <a href="/legal.html" class="legal-link-header">Legal & Policies</a>

  </div>
</header>


<div class="page-wrapper">
  <main>

    <div class="image-section">

      <div id="main-skeleton" class="skeleton"></div>

      <!-- ðŸ”’ MAIN IMAGE (INSIDE BOX) -->
      <div class="protected-wrapper">
        <img
          id="download-image"
          class="image-load protected-img"
          src=""
          alt="Selected Image"
          loading="lazy"
        />
        <div id="image-protect-overlay"></div>
      </div>

      <h2 id="image-name">Loading...</h2>

      <div class="image-actions">
        <button class="info-btn">
          <i class="fas fa-info-circle"></i> Info
        </button>

        <a id="download-link" href="#" download>
          <button class="download-btn">
            <i class="fas fa-download"></i> Download
          </button>
        </a>
      </div>

    </div>

    <!-- â­ Updated Keywords Block -->
    <div class="keywords" id="keywords"></div>

  </main>
</div>


<div class="related-wrapper">
  <h2>Related Images</h2>

  <div class="related-masonry" id="related-images">
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
  </div>
</div>


<!-- INFO MODAL -->
<div id="infoModal" class="info-modal">
  <div class="info-content">
    <span class="close-btn">&times;</span>
    <h2>Image Information</h2>
    <ul>
      <li><strong>Name:</strong> <span id="info-name">-</span></li>
      <li><strong>Dimensions:</strong> <span id="info-dimensions">-</span></li>
      <li><strong>File Size:</strong> <span id="info-size">-</span></li>
      <li><strong>Format:</strong> <span id="info-format">-</span></li>
      <li><strong>License:</strong> Free to use for commercial and personal purposes</li>
    </ul>
  </div>
</div>


<div id="cookie-banner" class="premium-cookie">
  <div class="cookie-content">
    <p class="cookie-message">
      We use cookies to enhance your browsing experience and analyze traffic.
    </p>
    <button id="cookie-accept" class="cookie-btn-premium">Got it</button>
  </div>
</div>

</body>

<script>
/* ---------------------------------- */
/* GLOBAL SETTINGS */
/* ---------------------------------- */
const API_BASE = "https://api.pixeora.com";

/* ---------------------------------- */
/* SUBJECT DETECTION */
/* ---------------------------------- */
function detectMainSubject(title) {
  if (!title) return "";
  const t = title.toLowerCase();

  const map = [
    ["tiger","tiger"],["lion","lion"],["cat","cat"],["dog","dog"],
    ["elephant","elephant"],["wolf","wolf"],["bear","bear"],["horse","horse"],
    ["bird","bird"],["duck","bird"],["eagle","bird"],["sparrow","bird"],["parrot","bird"],
    ["fish","fish"],["ocean","fish"],["underwater","fish"],["sea","fish"],["coral","fish"],
    ["bridge","bridge"],["building","architecture"],["architecture","architecture"],["city","architecture"],
    ["mountain","mountain"],["river","river"],["lake","lake"],["waterfall","waterfall"],["forest","forest"],
    ["girl","portrait"],["woman","portrait"],["man","portrait"],["kid","portrait"],["face","portrait"],["people","portrait"],
  ];

  for (let [word, subject] of map) {
    if (t.includes(word)) return subject;
  }
  return "";
}

/* ---------------------------------- */
/* UNIVERSAL ID + SLUG */
/* ---------------------------------- */
const rawSlug = decodeURIComponent(
  window.location.pathname.replace("/photo/", "")
);

const idMatch = rawSlug.match(/([a-f0-9]{24})$/i);
const imageId = idMatch ? idMatch[1] : null;
const cleanSlug = rawSlug.replace(/-[a-f0-9]{24}$/i, "");


/* ---------------------------------- */
/* DOWNLOAD HELPER â€” FORCED DOWNLOAD */
/* ---------------------------------- */
async function downloadImage(rawName) {
  const file = encodeURIComponent(rawName);
  const apiURL = `${API_BASE}/api/images/download/${file}`;

  // Non-blocking tracking
  try {
    navigator.sendBeacon
      ? navigator.sendBeacon(`${API_BASE}/api/images/track-download/${file}`)
      : fetch(`${API_BASE}/api/images/track-download/${file}`, { method: "POST" });
  } catch (e) {}

  // Force download using backend (works on all devices)
  window.location.href = apiURL;
}

async function loadImageDetails() {
  try {
    let apiList = [];

    // 1ï¸âƒ£ Mongo ID (BEST)
    if (imageId) {
      apiList.push(`${API_BASE}/api/images/slug/${imageId}`);
    }

    // 2ï¸âƒ£ Clean slug (stored in DB)
    if (cleanSlug) {
      apiList.push(`${API_BASE}/api/images/slug/${cleanSlug}`);
    }

    let img = null;

    for (let url of apiList) {
      const res = await fetch(url);
      if (!res.ok) continue;

      const j = await res.json();
      img = j.image || j.data || j.result || j;

      if (Array.isArray(img)) img = img[0];
      if (img && (img._id || img.fileName)) break;
    }

    // ðŸš¨ HARD STOP IF NOT FOUND
    if (!img) {
      document.getElementById("image-name").textContent = "Image Not Found.";
      return;
    }

    // Normalize ID
    if (!img._id && img.id) img._id = img.id;

    // CDN URLs
    const file = encodeURIComponent(img.fileName || img.file || "");
    const thumbUrl = img.thumbnailFileName
      ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
      : (file ? `https://cdn.pixeora.com/thumbs/${file}` : "");

    const originalUrl = file
      ? `https://cdn.pixeora.com/${file}`
      : (img.url || "");

    const mainImg = document.getElementById("download-image");
    const skeleton = document.getElementById("main-skeleton");

    // Thumbnail first
    if (thumbUrl) {
      mainImg.src = thumbUrl;
      mainImg.style.filter = "blur(3px)";
      mainImg.style.opacity = "0.2";
    } else if (originalUrl) {
      mainImg.src = originalUrl;
      mainImg.style.filter = "blur(3px)";
      mainImg.style.opacity = "0.2";
    }

    skeleton.style.display = "none";

    // HD preload
    if (originalUrl) {
      const hd = new Image();
      hd.src = originalUrl;
      hd.onload = () => {
        mainImg.src = originalUrl;
        mainImg.style.transition = "filter .4s ease, opacity .3s ease";
        mainImg.style.filter = "blur(0)";
        mainImg.style.opacity = "1";

        if (hd.naturalWidth && hd.naturalHeight) {
          mainImg.style.aspectRatio =
            `${hd.naturalWidth}/${hd.naturalHeight}`;
        }
      };
    }

    // Title
    const safeTitle =
      img.title?.trim() ||
      img.fileName?.trim() ||
      img.slug?.trim() ||
      "Untitled Image";

    document.getElementById("image-name").textContent = safeTitle;
    document.title = `${safeTitle} â€” Pixeora`;

    // Download
    const downloadAnchor = document.getElementById("download-link");
    if (downloadAnchor && file) {
      downloadAnchor.href = `${API_BASE}/api/images/download/${file}`;
      downloadAnchor.setAttribute("download", img.fileName || "");
    }

    window.__originalFileName = img.fileName || img.file || "";

    // Schema
    const ld = {
      "@context": "https://schema.org",
      "@type": "ImageObject",
      "name": safeTitle,
      "description": img.description || "",
      "contentUrl": originalUrl,
      "thumbnailUrl": thumbUrl,
      "creator": { "@type": "Organization", "name": "Pixeora" },
      "license": "https://pixeora.com/license"
    };

    document.getElementById("ld-json").textContent = JSON.stringify(ld);

    // Keywords
    const keywords =
      img.keywords?.length ? img.keywords :
      img.tags?.length ? img.tags : [];

    const kwEl = document.getElementById("keywords");
    if (kwEl) {
      kwEl.innerHTML = keywords
        .map(t => `<span onclick="location.href='/search.html?query=${encodeURIComponent(t)}'">${t}</span>`)
        .join("");
    }

    // Related
    const subject = detectMainSubject(img.title || img.fileName || "");
    startRelatedSystem([subject, img.category, ...keywords.slice(0, 6)].filter(Boolean));

  } catch (err) {
    console.error("Loader Error:", err);
    document.getElementById("image-name").textContent = "Image Not Found.";
  }
}


/* ---------------------------------- */
/* RELATED SYSTEM â€“ STABLE + SEARCH MATCH */
/* ---------------------------------- */

let relatedKeywordList = [];
let relatedKeywordIndex = 0;
let relatedPage = 1;
let relatedLoading = false;
let loadedIds = new Set();
let relatedColIndex = 0;
let relatedCursor = null;


/* Helper slug */
function slugify(text = "") {
  return text.toString().toLowerCase()
    .replace(/[^\w ]+/g, "")
    .replace(/\s+/g, "-")
    .trim();
}

/* START RELATED */
function startRelatedSystem(keywords = []) {

  relatedColIndex = 0;
  relatedKeywordIndex = 0;
  relatedPage = 1;
  relatedLoading = false;
  relatedCursor = null;
  loadedIds.clear();

  const grid = document.querySelector("#related-images");
  if (!grid) return;

  /* Reset grid */
  grid.innerHTML = `
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  `;

  /* If keywords missing â†’ fallback immediately */
  if (!keywords.length) {
    loadRelatedFallback();
    return;
  }

  const strongWords = [
    "tiger","lion","cat","dog","elephant","wolf","bear","horse",
    "bird","fish","bridge","architecture","mountain","river",
    "waterfall","forest","portrait","face","people"
  ];

  const main = keywords[0]?.toLowerCase() || "";
  const strong = [];
  const medium = [];
  const weak = [];

  keywords.forEach(k => {
    const kw = k.toLowerCase();
    if (main && kw.includes(main)) strong.push(k);
    else if (strongWords.some(sw => kw.includes(sw))) medium.push(k);
    else weak.push(k);
  });

  relatedKeywordList = [...new Set([...strong, ...medium, ...weak])];

  if (!relatedKeywordList.length) {
    loadRelatedFallback();
    return;
  }

  loadNextKeywordBatch();
}

/* LOAD FIRST KEYWORD */
async function loadNextKeywordBatch() {
  if (relatedKeywordIndex >= relatedKeywordList.length) return;
  const keyword = relatedKeywordList[relatedKeywordIndex++];
  relatedPage = 1;
  await loadMoreRelated(keyword);
}

/* LOAD MORE */
async function loadMoreRelated(keyword) {
  if (relatedLoading) return true;
  relatedLoading = true;

  try {
    const url = relatedCursor
      ? `${API_BASE}/api/search/next?q=${encodeURIComponent(keyword)}&cursor=${relatedCursor}&limit=20`
      : `${API_BASE}/api/search/first?q=${encodeURIComponent(keyword)}&limit=20`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("Search API failed");

    const data = await res.json();

    const images = data.images || [];
    relatedCursor = data.nextCursor || null;

    const unique = images.filter(img => {
      const id = img._id || img.id;
      if (!id || loadedIds.has(id)) return false;
      loadedIds.add(id);
      if (!img._id) img._id = id;
      return true;
    });

    if (!unique.length) {
      relatedLoading = false;
      return false;
    }

    displayRelated(unique);
    relatedLoading = false;
    return true;

  } catch (e) {
    console.error("Related error:", e);
    relatedLoading = false;
    return false;
  }
}

/* DISPLAY */
function displayRelated(images) {

  const cols = Array.from(
    document.querySelectorAll("#related-images .masonry-col")
  ).filter(col => getComputedStyle(col).display !== "none");

  if (!cols.length) return;

  images.forEach(img => {

    const safeSlug =
      img.slug || slugify(img.title || img.fileName || "image");

    const thumb =
      img.thumbnailFileName
        ? `https://cdn.pixeora.com/${encodeURIComponent(img.thumbnailFileName)}`
        : `https://cdn.pixeora.com/${encodeURIComponent(img.fileName)}`;

    const card = document.createElement("div");
    card.className = "image-item";

    card.innerHTML = `
      <div class="image-wrapper">
        <div class="skeleton"></div>
        <a href="/photo/${safeSlug}-${img._id}">
          <img data-src="${thumb}" class="lazy-img image-load" alt="${img.title || ''}">
        </a>
        <span class="download-overlay"
          onclick="event.stopPropagation(); downloadImage('${(img.fileName || "").replace(/'/g,"\\'")}')">
        </span>
      </div>
    `;

    cols[relatedColIndex].appendChild(card);
    relatedColIndex = (relatedColIndex + 1) % cols.length;
  });

  lazyLoadInit();
}

/* ---------------------------------- */
/* FALLBACK â€” GUARANTEED CONTENT */
/* ---------------------------------- */
async function loadRelatedFallback() {

  const r = await fetch(`${API_BASE}/api/images/popular-latest?limit=200`);
  const pop = await r.json();
  let images = pop.images || [];

  images = images.sort(() => Math.random() - 0.5);

  displayRelated(images.slice(0, 50));
}

/* ---------------------------------- */
/* INFINITE SCROLL */
/* ---------------------------------- */
window.addEventListener("scroll", async () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 400) {
    const keyword = relatedKeywordList[relatedKeywordIndex - 1];
    if (!keyword) return;

    const loaded = await loadMoreRelated(keyword);
    if (!loaded) loadNextKeywordBatch();
  }
});

/* ---------------------------------- */
/* LAZY LOADING */
/* ---------------------------------- */
function lazyLoadInit() {
  const lazyImages = document.querySelectorAll("img.lazy-img");

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;

        const img = entry.target;
        img.src = img.dataset.src;

        img.onload = () => {
          img.classList.add("image-loaded");
          img.closest(".image-wrapper").querySelector(".skeleton").remove();
        };

        img.classList.remove("lazy-img");
        obs.unobserve(img);
      });
    },
    { rootMargin: "400px 0px" }
  );

  lazyImages.forEach(img => observer.observe(img));
}

/* ---------------------------------- */
/* INFO MODAL */
/* ---------------------------------- */
const modal = document.getElementById("infoModal");
const infoBtn = document.querySelector(".info-btn");
const closeBtn = document.querySelector(".close-btn");

infoBtn.onclick = async () => {
  modal.classList.add("active");

  const originalUrl = `https://cdn.pixeora.com/${encodeURIComponent(window.__originalFileName)}`;
  document.getElementById("info-name").textContent =
    document.getElementById("image-name").textContent;

  try {
    const tmp = new Image();
    tmp.src = originalUrl;
    await tmp.decode();

    document.getElementById("info-dimensions").textContent =
      `${tmp.naturalWidth} Ã— ${tmp.naturalHeight}px`;

    const head = await fetch(originalUrl, { method: "HEAD" });
    const size = head.headers.get("content-length");

    document.getElementById("info-size").textContent =
      size ? (size / (1024 * 1024)).toFixed(2) + " MB" : "Unknown";

    const ext = originalUrl.split(".").pop().split("?")[0].toUpperCase();
    document.getElementById("info-format").textContent = ext;

  } catch (e) {
    document.getElementById("info-dimensions").textContent = "-";
    document.getElementById("info-size").textContent = "-";
    document.getElementById("info-format").textContent = "-";
  }
};

closeBtn.onclick = () => modal.classList.remove("active");
window.onclick = (e) => { if (e.target === modal) modal.classList.remove("active"); };

/* ---------------------------------- */
/* COOKIE + IMAGE LOAD + SEARCH â€” SINGLE CLEAN DOM READY */
/* ---------------------------------- */
document.addEventListener("DOMContentLoaded", function () {

  /* SEARCH FORM */
  const form = document.getElementById("searchForm");
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = document.getElementById("searchInput").value.trim();
      if (q.length > 0) {
        window.location.href = `/search.html?query=${encodeURIComponent(q)}`;
      }
    });
  }

  /* LOAD IMAGE DETAILS */
  loadImageDetails();

  /* COOKIE BANNER */
  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("cookie-accept");

  if (!localStorage.getItem("cookieConsent")) {
    setTimeout(() => banner.classList.add("show"), 500);
  }

  acceptBtn.addEventListener("click", () => {
    localStorage.setItem("cookieConsent", "true");
    banner.classList.remove("show");
  });
    /* TOUCH PROTECTION */
  const overlay = document.getElementById("image-protect-overlay");
  if (overlay) {
    overlay.addEventListener("touchstart", (e) => {
      e.preventDefault();
    });
  }

});



</script>
