<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search - Pixeora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <link rel="stylesheet" href="css/search.css">
  <link href="https://fonts.googleapis.com/css2?family=Marck+Script&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@900&display=swap" rel="stylesheet">

  <meta name="description" content="Search and download free HD wallpapers & stock images on Pixeora. Nature, Technology, Travel, Food, and more.">
  <meta property="og:title" content="Pixeora - Free Stock Images Search">
  <meta property="og:description" content="Explore free HD wallpapers and images for any category.">
  <meta property="og:type" content="website">
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-overlay">

    <a href="index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" onsubmit="return redirectSearch()">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="images/search-icon.png" alt="Search">
          </button>
        </form>
      </div>
    </div>

    <a href="legal.html" class="legal-link-header">Legal & Policies</a>
  </div>
</header>

<!-- Search Info -->
<div class="search-info">
  <p>Showing Results for</p>
  <h1><span class="keyword">""</span></h1>
  <div class="image-count" id="image-count">0 Images</div>
</div>

<!-- Gallery -->
<section class="search-results">
  <div class="masonry-grid" id="masonry">
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  </div>
</section>

<!-- Related Section -->
<div class="related-section" id="related-section" style="display:none;">
  <h2>Related Images</h2>
  <div id="related-images"></div>
</div>

<script>
const API_BASE = "https://api.pixeora.com";

const params = new URLSearchParams(window.location.search);
const query = params.get('query');

const keywordSpan = document.querySelector('.keyword');
const imageCountDiv = document.getElementById('image-count');

const relatedSection = document.getElementById("related-section");
const relatedContainer = document.getElementById("related-images");

const PLACEHOLDER_SRC = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

let lazyObserver = null;

/* ======================================================
   LAZY LOADING + SKELETON
====================================================== */
function initLazyObserver() {
  if (!("IntersectionObserver" in window)) {
    document.querySelectorAll("img.lazy-img[data-src]").forEach(img => {
      img.src = img.dataset.src;
      img.classList.add("image-loaded");
      img.removeAttribute("data-src");
    });
    return;
  }

  if (lazyObserver) return;

  lazyObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;

      const img = entry.target;
      const realSrc = img.dataset.src;

      if (realSrc) {
        img.src = realSrc;

        img.onload = () => {
          img.classList.add("image-loaded");
          const skeleton = img.closest(".image-wrapper").querySelector(".skeleton");
          if (skeleton) skeleton.remove();
        };

        img.removeAttribute("data-src");
      }

      observer.unobserve(img);
    });
  }, { rootMargin: "200px 0px" });
}

function registerLazyImages(scope) {
  initLazyObserver();
  if (!lazyObserver) return;

  const imgs = scope.querySelectorAll("img.lazy-img[data-src]");
  imgs.forEach(img => lazyObserver.observe(img));
}

/* ======================================================
   INITIAL QUERY LOAD
====================================================== */
if (query) {
  keywordSpan.textContent = `"${query.charAt(0).toUpperCase() + query.slice(1)}"`;
  loadSearchImages(query);
}

/* ======================================================
   SEARCH REDIRECT
====================================================== */
function redirectSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (q) window.location.href = `search.html?query=${encodeURIComponent(q)}`;
  return false;
}

/* ======================================================
   DOWNLOAD HANDLER
====================================================== */
function downloadImage(rawName) {
  if (!rawName) return;
  window.location.href = `${API_BASE}/api/images/download/${encodeURIComponent(rawName)}`;
}

/* ======================================================
   NEW MASONRY GRID
====================================================== */
const masonry = document.getElementById("masonry");
const cols = Array.from(document.querySelectorAll(".masonry-col"));
let colIndex = 0;

function addToNextColumn(card) {
  cols[colIndex].appendChild(card);
  colIndex = (colIndex + 1) % cols.length;
}

function createSearchCard(img) {
  const div = document.createElement("div");
  div.classList.add("image-item");

  const url = img.thumbnailUrl || `/api/images/file/${img.thumbnailFileName}`;

  div.innerHTML = `
    <div class="image-wrapper">
      <div class="skeleton"></div>
      <a href="/photo/${img.slug}-${img._id}">
        <img
          data-src="${url}"
          class="lazy-img image-load"
          alt="${img.alt || img.title || ''}"
        >
      </a>
      <span class="download-overlay"
        onclick="downloadImage('${img.fileName.replace(/'/g, '\\\'')}')">
      </span>
    </div>
  `;

  return div;
}

/* ======================================================
   LOAD SEARCH RESULTS
====================================================== */
async function loadSearchImages(q) {
  try {
    const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(q)}`);
    const images = await res.json();

    imageCountDiv.textContent = `${images.length} Images`;

    cols.forEach(c => (c.innerHTML = "")); // clear columns
    colIndex = 0;

    if (!images.length) {
      loadRelatedImages(q);
      return;
    }

    images.forEach(img => {
      const card = createSearchCard(img);
      addToNextColumn(card);
    });

    registerLazyImages(document);

  } catch (err) {
    console.error(err);
  }
}

/* ======================================================
   LOAD RELATED IMAGES
====================================================== */
async function loadRelatedImages(keyword) {
  try {
    relatedSection.style.display = "block";

    const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(keyword)}`);
    const images = await res.json();

    relatedContainer.innerHTML = "";

    images.slice(0, 15).forEach(img => {
      const url =
        img.thumbnailUrl ||
        `/api/images/file/${img.thumbnailFileName}`;

      relatedContainer.innerHTML += `
        <div class="related-item">
          <div class="image-wrapper">
            <div class="skeleton"></div>
            <a href="/photo/${img.slug}-${img._id}">
              <img
                data-src="${url}"
                class="lazy-img image-load"
              >
            </a>
            <span class="download-overlay"
              onclick="downloadImage('${img.fileName.replace(/'/g, '\\\'')}')">
            </span>
          </div>
        </div>
      `;
    });

    registerLazyImages(document);

  } catch (e) {
    console.error(e);
  }
}
