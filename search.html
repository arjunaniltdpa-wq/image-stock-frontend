<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search - Pixeora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <link rel="preload" href="css/search.css" as="style">
  <link rel="stylesheet" href="css/search.css">
  <link href="https://fonts.googleapis.com/css2?family=Marck+Script&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@900&display=swap" rel="stylesheet">

  <meta name="description" content="Search and download free HD wallpapers & stock images on Pixeora. Nature, Technology, Travel, Food, and more.">
  <meta property="og:title" content="Pixeora - Free Stock Images Search">
  <meta property="og:description" content="Explore free HD wallpapers and images for any category.">
  <meta property="og:type" content="website">

  <link rel="preconnect" href="https://cdn.pixeora.com" crossorigin>
  

</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-overlay">

    <a href="index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" onsubmit="return redirectSearch()">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="images/search-icon.png" alt="Search">
          </button>
        </form>
      </div>
    </div>

    <a href="legal.html" class="legal-link-header">Legal & Policies</a>
  </div>
</header>

<!-- Search Info -->
<div class="search-info">
  <p>Showing Results for</p>
  <h1><span class="keyword">""</span></h1>
  <div class="image-count" id="image-count">0 Images</div>
</div>

<!-- Gallery -->
<section class="search-results">
  <div class="masonry-grid" id="masonry">
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  </div>
</section>

<div class="related-section" id="related-section" style="display:none;">
  <h2>Related Images</h2>

  <div class="related-masonry" id="related-images">
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div> <!-- â­ 5 columns -->
  </div>
</div>


<script>
const API_BASE = "https://api.pixeora.com";

const params = new URLSearchParams(window.location.search);
const query = params.get("query");

const keywordSpan = document.querySelector(".keyword");
const imageCountDiv = document.getElementById("image-count");

const relatedSection = document.getElementById("related-section");
const relatedContainer = document.getElementById("related-images");

/* MAIN MASONRY */
const masonry = document.getElementById("masonry");
const cols = Array.from(masonry.querySelectorAll(".masonry-col"));
let colIndex = 0;

/* DOWNLOAD */
function downloadImage(rawName) {
  window.location.href =
    `${API_BASE}/api/images/download/${encodeURIComponent(rawName)}`;
}

/* CARD */
function createCard(img) {
  const div = document.createElement("div");
  div.classList.add("image-item");

  const file = img.thumbnailFileName || img.fileName;
  const url = `https://cdn.pixeora.com/${encodeURIComponent(file)}`;

  div.innerHTML = `
    <div class="image-wrapper">
      <div class="skeleton"></div>

      <a href="/photo/${img.slug}-${img._id}">
        <img 
          data-src="${url}" 
          class="lazy-img image-load"
          alt="${img.alt || img.title || ""}"
        >
      </a>

      <span class="download-overlay"
        onclick="downloadImage('${img.fileName.replace(/'/g,"\\'")}')">
      </span>
    </div>
  `;

  return div;
}

/* ADD MAIN COLUMN */
function addToNextColumn(card) {
  cols[colIndex].appendChild(card);
  colIndex = (colIndex + 1) % cols.length;
}

/* LAZY LOAD */
function lazyLoadInit() {
  const lazyImages = document.querySelectorAll("img.lazy-img");

  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;

      const img = entry.target;
      img.src = img.dataset.src;

      img.onload = () => {
        img.classList.add("image-loaded");
        const sk = img.closest(".image-wrapper").querySelector(".skeleton");
        if (sk) sk.remove();
      };

      img.classList.remove("lazy-img");
      obs.unobserve(img);
    });
  });

  lazyImages.forEach(img => observer.observe(img));
}

function applyImageLoadAnimation() {
  document.querySelectorAll(".image-load").forEach(img => {
    img.onload = () => {
      img.classList.add("image-loaded");
      const sk = img.closest(".image-wrapper")?.querySelector(".skeleton");
      if (sk) sk.remove();
    };
  });
}

/* LOAD MAIN SEARCH RESULTS */
async function loadSearchImages(q) {
  try {
    const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(q)}`);
    let images = await res.json();

    imageCountDiv.textContent = `${images.length} Images`;

    cols.forEach(c => (c.innerHTML = ""));
    colIndex = 0;

    if (!images.length) {
      masonry.innerHTML = "<p>No images found.</p>";
      loadRelatedInitial(q);
      return;
    }

    images.forEach(img => {
      addToNextColumn(createCard(img));
    });

    lazyLoadInit();
    applyImageLoadAnimation();

    loadRelatedInitial(q);

  } catch (err) {
    console.error(err);
  }
}

/* SHUFFLE */
function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

/* -------------------------
   RELATED SECTION PAGINATION
---------------------------*/

let relatedAll = [];       // STORE ALL images here  
let relatedIndex = 0;      // POINTER  
const RELATED_BATCH = 30;  // LOAD 30 each scroll  

async function loadRelatedInitial(keyword) {
  relatedSection.style.display = "block";

  const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(keyword)}`);
  relatedAll = await res.json();

  // fallback to POPULAR if empty
  if (!relatedAll.length) {
    const r = await fetch(`${API_BASE}/api/images/popular?page=1&limit=200`);
    relatedAll = (await r.json()).images || [];
  }

  // SHUFFLE ALL
  relatedAll = shuffle(relatedAll);

  loadNextRelatedBatch();
}

/* LOAD NEXT 30 RELATED IMAGES */
function loadNextRelatedBatch() {
  const relatedCols = relatedContainer.querySelectorAll(".related-col");

  let end = relatedIndex + RELATED_BATCH;
  const batch = relatedAll.slice(relatedIndex, end);

  // stop if no more images
  if (!batch.length) return;

  let col = 0;
  batch.forEach(img => {
    const card = createCard(img);
    relatedCols[col].appendChild(card);
    col = (col + 1) % relatedCols.length;
  });

  relatedIndex = end;

  lazyLoadInit();
  applyImageLoadAnimation();
}

/* INFINITY SCROLL */
window.addEventListener("scroll", () => {
  const rect = relatedSection.getBoundingClientRect();
  const trigger = rect.bottom - window.innerHeight < 500;

  if (trigger) {
    loadNextRelatedBatch();
  }
});

/* SEARCH REDIRECT */
function redirectSearch() {
  const q = document.getElementById("searchInput").value.trim();
  if (q) window.location.href = `search.html?query=${encodeURIComponent(q)}`;
  return false;
}

/* START */
if (query) {
  keywordSpan.textContent = `"${query.charAt(0).toUpperCase() + query.slice(1)}"`;
  loadSearchImages(query);
}
</script>
