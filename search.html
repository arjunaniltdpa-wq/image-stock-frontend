<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

  <title>Search Free HD Wallpapers & Stock Images | Pixeora</title>

  <!-- NOINDEX SEARCH RESULTS -->
  <meta name="robots" content="noindex, follow">

  <meta name="description"
        content="Search millions of free HD wallpapers, 4K backgrounds, and royalty-free stock images on Pixeora.">

  <!-- Styles -->
  <link rel="preload" href="css/search.css" as="style">
  <link rel="stylesheet" href="css/search.css">
  <link rel="stylesheet" href="css/cookie.css">

  <!-- Performance -->
  <link rel="preconnect" href="https://cdn.pixeora.com" crossorigin>
  <link rel="preconnect" href="https://api.pixeora.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Marck+Script&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@900&display=swap" rel="stylesheet">

  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Open Graph (generic brand) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Pixeora Search">
  <meta property="og:description" content="Search free HD wallpapers and stock images on Pixeora.">
  <meta property="og:image" content="https://pixeora.com/images/og-image.jpg">

  <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Pixeora",
    "url": "https://pixeora.com",
    "logo": "https://pixeora.com/images/logo.png"
  }
  </script>

  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VPX3GGRR7H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VPX3GGRR7H');
  </script>
</head>

<!-- Header -->
<header class="header">
  <div class="header-overlay">

    <a href="index.html" class="logo">Pixeora</a>

    <div class="search-bar-wrapper">
      <div class="search-bar-border">
        <form class="search-bar" onsubmit="return redirectSearch()">
          <input type="text" id="searchInput" placeholder="Search Image" required>
          <button type="submit" class="search-icon">
            <img src="images/search-icon.png" alt="Search">
          </button>
        </form>
      </div>
    </div>

    <a href="legal.html" class="legal-link-header">Legal & Policies</a>
  </div>
</header>

<!-- Search Info -->
<div class="search-info">
  <p>Showing Results for</p>
  <h1><span class="keyword">""</span></h1>
  <div class="image-count" id="image-count">0 Images</div>
</div>

<button id="goTopBtn" aria-label="Go to top">
  <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M8 5l8 7-8 7" />
  </svg>
</button>

<!-- Gallery -->
<section class="search-results">
  <div class="masonry-grid" id="masonry">
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
    <div class="masonry-col"></div>
  </div>
</section>

<div class="related-section" id="related-section" style="display:none;">
  <h2>Explore More</h2>

  <div class="related-masonry" id="related-images">
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div>
    <div class="related-col"></div> <!-- â­ 5 columns -->
  </div>
</div>

<div class="load-more-wrapper" id="loadMoreSection" style="display:none;">
  <button class="load-more-btn" onclick="loadMoreImages()">Load More</button>
</div>


<div id="cookie-banner" class="premium-cookie">
  <div class="cookie-content">
    <p class="cookie-message">
      We use cookies to enhance your browsing experience and analyze traffic.
    </p>
    <button id="cookie-accept" class="cookie-btn-premium">Got it</button>
  </div>
</div>

<script>
const API_BASE = "https://api.pixeora.com";

const params = new URLSearchParams(window.location.search);
let query = params.get("query") || params.get("q");

const keywordSpan = document.querySelector(".keyword");
const imageCountDiv = document.getElementById("image-count");

const relatedSection = document.getElementById("related-section");
const relatedContainer = document.getElementById("related-images");

/* MAIN MASONRY */
const masonry = document.getElementById("masonry");
const cols = Array.from(masonry.querySelectorAll(".masonry-col"));
let colIndex = 0;

/* Search Pagination */
let nextCursor = null;
let totalImages = 0;

/* DOWNLOAD */
function downloadImage(rawName) {
  const url = `${API_BASE}/api/images/download/${encodeURIComponent(rawName)}`;
  window.location.href = url;
}

/* DELEGATED DOWNLOAD */
document.addEventListener("click", (ev) => {
  const overlay = ev.target.closest && ev.target.closest(".download-overlay");
  if (overlay) {
    ev.stopImmediatePropagation();
    ev.preventDefault();
    const raw = overlay.getAttribute("data-file");
    if (raw) downloadImage(raw);
    return;
  }
}, true);

/* CARD TEMPLATE */
function createCard(img, index = 999) {
  const div = document.createElement("div");
  div.classList.add("image-item");

  if (!img.thumbnailFileName) return null;
  const file = img.thumbnailFileName;

  const url = `https://cdn.pixeora.com/${encodeURIComponent(file)}`;
  const safeFileAttr = String(img.fileName || "").replace(/"/g, "&quot;");

  div.innerHTML = `
    <div class="image-wrapper">
      <div class="skeleton"></div>
      <a href="/photo/${img.slug || ""}-${img._id || ""}" class="image-link">
        <img
          data-src="${url}"
          loading="lazy"
          decoding="async"
          class="lazy-img image-load"
          alt="${(img.alt || img.title || "")}"
          ${index < 2 ? 'fetchpriority="high"' : ''}
        >
      </a>
      <span class="download-overlay" data-file="${safeFileAttr}"></span>
    </div>
  `;
  return div;
}

/* COLUMN INSERT */
function addToNextColumn(card) {
  cols[colIndex].appendChild(card);
  colIndex = (colIndex + 1) % cols.length;
}

/* ================= LAZY LOAD (OPTIMIZED) ================= */

let imageObserver;

function lazyLoadInit() {
  if (!imageObserver) {
    imageObserver = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;

        const img = entry.target;

        // Start loading immediately
        img.src = img.dataset.src;

        img.onload = img.onerror = () => {
          img.classList.add("image-loaded");
          const sk = img.closest(".image-wrapper")?.querySelector(".skeleton");
          if (sk) sk.remove();
        };

        img.classList.remove("lazy-img");
        obs.unobserve(img);
      });
    }, {
      rootMargin: "600px 0px", // aggressive preloading like Unsplash
      threshold: 0.01
    });
  }

  document.querySelectorAll("img.lazy-img").forEach(img => {
    imageObserver.observe(img);
  });
}
function preloadFirstRow(images) {
  images.slice(0, 4).forEach(img => {
    const file = img.thumbnailFileName || img.fileName;
    if (!file) return;

    const link = document.createElement("link");
    link.rel = "preload";
    link.as = "image";
    link.href = `https://cdn.pixeora.com/${encodeURIComponent(file)}`;
    link.fetchpriority = "high";
    document.head.appendChild(link);
  });
}

/* ================= LOAD FIRST SEARCH RESULTS ================= */
/* ================= LOAD FIRST SEARCH RESULTS ================= */
const FIRST_RENDER_COUNT = 8;   // instant
const SCROLL_BATCH = 12;       // load on scroll

let bufferedImages = [];
let bufferIndex = 0;

async function loadSearchFirst(q) {
  try {
    // ðŸŸ¢ 1ï¸âƒ£ INSTANT skeletons (NO WAIT)
    cols.forEach(c => (c.innerHTML = ""));
    colIndex = 0;

    for (let i = 0; i < FIRST_RENDER_COUNT; i++) {
      const sk = document.createElement("div");
      sk.className = "image-item";
      sk.innerHTML = `
        <div class="image-wrapper">
          <div class="skeleton"></div>
        </div>
      `;
      addToNextColumn(sk);
    }

    // ðŸŸ¢ 2ï¸âƒ£ Fetch AFTER UI paints
    const res = await fetch(
      `${API_BASE}/api/search/first?q=${encodeURIComponent(q)}&limit=50`
    );
    const data = await res.json();

    bufferedImages = data.images || [];
    bufferIndex = 0;
    nextCursor = data.nextCursor;
    totalImages = data.total || bufferedImages.length;

    imageCountDiv.textContent = `${totalImages} Images`;

    // ðŸŸ¢ 3ï¸âƒ£ Replace skeletons with REAL images
    cols.forEach(c => (c.innerHTML = ""));
    colIndex = 0;

    if (!bufferedImages.length) {
      masonry.innerHTML = "<p>No images found.</p>";
      loadRelatedInitial(q);
      return;
    }

    relatedSection.style.display = "none";

    bufferedImages.slice(0, FIRST_RENDER_COUNT).forEach((img, i) => {
      addToNextColumn(createCard(img, i));
    });

    preloadFirstRow(bufferedImages);

    bufferIndex = FIRST_RENDER_COUNT;
    lazyLoadInit();
    toggleLoadMore();

  } catch (err) {
    console.error("SEARCH FIRST ERROR:", err);
  }
}

function maybeAppendMore() {
  if (bufferIndex >= bufferedImages.length) return;

  const batch = bufferedImages.slice(
    bufferIndex,
    bufferIndex + SCROLL_BATCH
  );

  batch.forEach(img => addToNextColumn(createCard(img)));
  bufferIndex += SCROLL_BATCH;

  lazyLoadInit();
}

/* ================= LOAD MORE BUTTON ================= */

function toggleLoadMore() {
  const section = document.getElementById("loadMoreSection");

  if (nextCursor) {
    section.style.display = "block";
  } else {
    section.style.display = "none";
  }
}


/* ================= LOAD NEXT SEARCH RESULTS ================= */

async function loadSearchNext() {
  if (!nextCursor) return;

  const res = await fetch(
    `${API_BASE}/api/search/next?q=${encodeURIComponent(query)}&cursor=${nextCursor}&limit=50`
  );
  const data = await res.json();
  const images = data.images || [];

  nextCursor = data.nextCursor;

  images.forEach(img => addToNextColumn(createCard(img)));

  lazyLoadInit();
  toggleLoadMore();
}
function loadMoreImages() {
  loadSearchNext();
}

/* ================= RELATED FALLBACK ================= */

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

let relatedAll = [];
let relatedIndex = 0;
const RELATED_BATCH = 30;

async function loadRelatedInitial(keyword) {
  relatedSection.style.display = "block";

  const r = await fetch(`${API_BASE}/api/images/popular-latest?limit=200`);
  const pop = await r.json();
  relatedAll = shuffle(pop.images || []);
  relatedIndex = 0;
  loadNextRelatedBatch();
}

function loadNextRelatedBatch() {
  const relatedCols = relatedContainer.querySelectorAll(".related-col");
  const batch = relatedAll.slice(relatedIndex, relatedIndex + RELATED_BATCH);
  if (!batch.length) return;

  let col = 0;
  batch.forEach(img => {
    relatedCols[col].appendChild(createCard(img));
    col = (col + 1) % relatedCols.length;
  });

  relatedIndex += RELATED_BATCH;
  lazyLoadInit();
}

let scrollTick = false;

window.addEventListener("scroll", () => {
  const scrollY = window.scrollY;

  // ðŸ”¼ Show / hide GO TOP button
  if (scrollY > 600) {
    goTopBtn.style.display = "flex";
  } else {
    goTopBtn.style.display = "none";
  }

  // â¬‡ï¸ Infinite scroll
  if (
    window.innerHeight + scrollY >=
    document.body.offsetHeight - 1200
  ) {
    maybeAppendMore();
  }
});

/* SEARCH REDIRECT */
function redirectSearch() {
  const q = document.getElementById("searchInput").value.trim();
  if (!q) return false;

  window.location.href = `/search.html?query=${encodeURIComponent(q)}`;
  return false;
}

window.addEventListener("popstate", () => {
  const params = new URLSearchParams(window.location.search);
  const q = params.get("query");
  if (q) {
    query = q; // ðŸ”¥ important
    keywordSpan.textContent = `"${q[0].toUpperCase() + q.slice(1)}"`;
    loadSearchFirst(q);
  }
});

// ðŸ”¥ INITIAL PAGE LOAD
if (query) {
  keywordSpan.textContent = `"${query[0].toUpperCase() + query.slice(1)}"`;
  loadSearchFirst(query);
}

/* ================= Top Button ================= */
const goTopBtn = document.getElementById("goTopBtn");

window.addEventListener("scroll", () => {
  if (
    window.innerHeight + window.scrollY >=
    document.body.offsetHeight - 1200
  ) {
    maybeAppendMore();
  }
});

goTopBtn.addEventListener("click", () => {
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
});

/* COOKIE */
document.addEventListener("DOMContentLoaded", function () {
  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("cookie-accept");

  if (!localStorage.getItem("cookieConsent")) {
    setTimeout(() => {
      banner.classList.add("show");
    }, 500);
  }

  acceptBtn.addEventListener("click", () => {
    localStorage.setItem("cookieConsent", "true");
    banner.classList.remove("show");
  });
});
</script>
